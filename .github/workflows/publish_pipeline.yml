name: publish ðŸš€

on:
  push:
    branches:
      - main
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  check-publish:
    runs-on: ubuntu-latest
    outputs:
      should_publish: ${{ steps.check.outputs.should_publish }}
      version_tag: ${{ steps.check.outputs.version_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check if commit should trigger publish
        id: check
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Triggered by tag push - check if tag is on main
            if git branch -r --contains ${{ github.sha }} | grep -q 'origin/main'; then
              echo "should_publish=true" >> $GITHUB_OUTPUT
              echo "version_tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            else
              echo "Tag ${{ github.ref_name }} is not on main branch, skipping publish"
              echo "should_publish=false" >> $GITHUB_OUTPUT
            fi
          else
            # Triggered by push to main - check if a new version tag was introduced by this merge
            # First check if tag points directly at this commit
            VERSION_TAG=$(git tag --points-at ${{ github.sha }} | grep -E '^v[0-9]' | head -n1)

            if [[ -z "$VERSION_TAG" ]]; then
              # No direct tag, check if merge introduced a new version tag
              # Get latest version tag reachable from HEAD
              LATEST_TAG=$(git describe --tags --match "v[0-9]*" --abbrev=0 HEAD 2>/dev/null || echo "")

              if [[ -n "$LATEST_TAG" ]]; then
                # Check if this tag was already reachable from previous main (first parent)
                PREV_TAG=$(git describe --tags --match "v[0-9]*" --abbrev=0 HEAD^1 2>/dev/null || echo "")

                if [[ "$LATEST_TAG" != "$PREV_TAG" ]]; then
                  VERSION_TAG="$LATEST_TAG"
                  echo "Found new version tag $VERSION_TAG introduced by this merge"
                fi
              fi
            fi

            if [[ -n "$VERSION_TAG" ]]; then
              echo "Publishing with version tag $VERSION_TAG"
              echo "should_publish=true" >> $GITHUB_OUTPUT
              echo "version_tag=$VERSION_TAG" >> $GITHUB_OUTPUT
            else
              echo "No new version tag in this commit, skipping publish"
              echo "should_publish=false" >> $GITHUB_OUTPUT
            fi
          fi

  publish:
    needs: check-publish
    if: needs.check-publish.outputs.should_publish == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Retrieve Docker Meta
        id: meta
        uses: docker/metadata-action@v5
        env:
          VERSION_TAG: ${{ needs.check-publish.outputs.version_tag }}
        with:
          images: |
            tatoalo/pressreader-automation
          tags: |
            type=semver,pattern=v{{version}},value=${{ needs.check-publish.outputs.version_tag }}
            type=semver,pattern={{major}}.{{minor}},value=${{ needs.check-publish.outputs.version_tag }}
            type=semver,pattern={{major}},value=${{ needs.check-publish.outputs.version_tag }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
